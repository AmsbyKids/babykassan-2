const fs = require('fs');
const axios = require('axios');
const cheerio = require('cheerio');
const { createAssistant } = require('./openai.service');
const OpenAI = require('openai');
const { DateTime } = require("luxon");

// Initiera OpenAI-klienten
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Lista Ã¶ver betrodda kÃ¤llor
const trustedSources = [
  {
    name: 'FÃ¶rsÃ¤kringskassan - FÃ¶rÃ¤ldrapenning',
    url: 'https://www.forsakringskassan.se/privatperson/foralder/foraldrapenning',
    selectors: 'article, .content-area, main, p, h1, h2, h3, li'
  },
  {
    name: 'FÃ¶rsÃ¤kringskassan - Nya regler 2025',
    url: 'https://www.forsakringskassan.se/nyhetsarkiv', 
    selectors: 'article, .content-area, .news-list, .news-item, h2, h3, p'
  }
];

// MaxgrÃ¤ns fÃ¶r SGI enligt FÃ¶rsÃ¤kringskassan
const MAX_SGI = 588000;
const ersÃ¤ttningsnivÃ¥ = 0.8;
const maxDagligErsÃ¤ttning = 1250;
const dagarPerÃ…r = 365;
const veckorPerMÃ¥nad = 4.33;

// Funktion fÃ¶r att berÃ¤kna exakt antal uttagsdagar och ersÃ¤ttning
function calculateParentalLeave(sgi, startDate, months1, daysPerWeek1, months2, daysPerWeek2) {
    let justeradSGI = Math.min(sgi, MAX_SGI);
    let dagligErsÃ¤ttning = Math.min((justeradSGI / dagarPerÃ…r) * ersÃ¤ttningsnivÃ¥, maxDagligErsÃ¤ttning);

    let veckor1 = months1 * veckorPerMÃ¥nad;
    let veckor2 = months2 * veckorPerMÃ¥nad;
    let uttagsdagar1 = Math.round(veckor1 * daysPerWeek1);
    let uttagsdagar2 = Math.round(veckor2 * daysPerWeek2);
    let totalDagar = uttagsdagar1 + uttagsdagar2;

    let ersÃ¤ttning1 = uttagsdagar1 * dagligErsÃ¤ttning;
    let ersÃ¤ttning2 = uttagsdagar2 * dagligErsÃ¤ttning;
    let totalErsÃ¤ttning = ersÃ¤ttning1 + ersÃ¤ttning2;

    let startDatum = DateTime.fromISO(startDate);
    let slutDatum = startDatum.plus({ days: totalDagar }).toFormat("dd MMMM yyyy");

    return {
        totalErsÃ¤ttning,
        totalDagar,
        slutDatum
    };
}

// HÃ¤mtar och sparar information frÃ¥n alla betrodda kÃ¤llor
async function collectNewInformation() {
  console.log(`ðŸ”„ Startar automatisk inlÃ¤rning ${new Date().toISOString()}`);

  let officialData = {};
  try {
    if (fs.existsSync('official_data.json')) {
      officialData = JSON.parse(fs.readFileSync('official_data.json', 'utf8'));
    }
  } catch (err) {
    console.error('Kunde inte lÃ¤sa official_data.json:', err);
  }

  let learningLog = [];
  try {
    if (fs.existsSync('learning_log.json')) {
      learningLog = JSON.parse(fs.readFileSync('learning_log.json', 'utf8'));
    }
  } catch (err) {
    console.error('Kunde inte lÃ¤sa learning_log.json:', err);
    learningLog = [];
  }

  let newInformation = '';
  let latestUpdateDate = new Date().toISOString();

  for (const source of trustedSources) {
    try {
      console.log(`ðŸ” SÃ¶ker information frÃ¥n ${source.name}: ${source.url}`);
      const response = await axios.get(source.url);
      const $ = cheerio.load(response.data);

      let pageContent = '';
      $(source.selectors).each((_, el) => {
        pageContent += $(el).text() + ' ';
      });

      if (pageContent.length > 100) {
        newInformation += `\n\n--- INFORMATION FRÃ…N ${source.name.toUpperCase()} ---\n${pageContent}`;
        console.log(`âœ… Hittade relevant information frÃ¥n ${source.name} (${pageContent.length} tecken)`);

        learningLog.push({
          timestamp: new Date().toISOString(),
          source: source.name,
          url: source.url,
          content_length: pageContent.length,
          content_summary: pageContent.substring(0, 150) + '...'
        });
      } else {
        console.log(`â„¹ï¸ Ingen relevant information hittades frÃ¥n ${source.name}`);
      }
    } catch (error) {
      console.error(`âŒ Fel vid hÃ¤mtning frÃ¥n ${source.name}:`, error.message);
    }
  }

  if (newInformation.length > 100) {
    console.log('ðŸ§  Analyserar ny information med OpenAI...');

    try {
      const analysisResponse
